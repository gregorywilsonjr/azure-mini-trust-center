{
  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "$connections": {
      "type": "Object"
    },
    "additionalSubscriptions": {
      "type": "String",
      "defaultValue": ""
    },
    "alertEmailAddress": {
      "type": "String",
      "defaultValue": ""
    },
    "teamsWebhook": {
      "type": "String",
      "defaultValue": ""
    },
    "retentionDays": {
      "type": "Int",
      "defaultValue": 30
    }
  },
  "triggers": {
    "Every_15_Minutes": {
      "recurrence": {
        "frequency": "Minute",
        "interval": 15
      },
      "type": "Recurrence"
    }
  },
  "actions": {
    "Comment_Why_Multi_Sub": {
      "type": "Compose",
      "inputs": "This workflow collects compliance data from multiple Azure subscriptions. Why: Enterprises typically have dev/test/prod subscriptions that all need monitoring. Aggregating data provides a complete compliance picture.",
      "runAfter": {}
    },
    "Initialize_Subscription_List": {
      "type": "InitializeVariable",
      "inputs": {
        "variables": [
          {
            "name": "subscriptionIds",
            "type": "Array",
            "value": "@split(if(empty(parameters('additionalSubscriptions')), '', parameters('additionalSubscriptions')), ',')"
          }
        ]
      },
      "runAfter": {
        "Comment_Why_Multi_Sub": ["Succeeded"]
      }
    },
    "Initialize_Timestamp": {
      "type": "InitializeVariable",
      "inputs": {
        "variables": [
          {
            "name": "currentTimestamp",
            "type": "String",
            "value": "@{utcNow()}"
          }
        ]
      },
      "runAfter": {
        "Initialize_Subscription_List": ["Succeeded"]
      }
    },
    "Initialize_Alert_Needed": {
      "type": "InitializeVariable",
      "inputs": {
        "variables": [
          {
            "name": "alertNeeded",
            "type": "Boolean",
            "value": false
          }
        ]
      },
      "runAfter": {
        "Initialize_Timestamp": ["Succeeded"]
      }
    },
    "Initialize_Alert_Message": {
      "type": "InitializeVariable",
      "inputs": {
        "variables": [
          {
            "name": "alertMessage",
            "type": "String",
            "value": ""
          }
        ]
      },
      "runAfter": {
        "Initialize_Alert_Needed": ["Succeeded"]
      }
    },
    "Comment_Why_Parallel_Collection": {
      "type": "Compose",
      "inputs": "Parallel API calls reduce total execution time. Why: Instead of waiting 5+ seconds for sequential calls, we complete all data collection in ~1-2 seconds.",
      "runAfter": {
        "Initialize_Alert_Message": ["Succeeded"]
      }
    },
    "Get_Availability_Data": {
      "type": "Http",
      "inputs": {
        "method": "GET",
        "uri": "https://management.azure.com/subscriptions/@{subscription().subscriptionId}/resourceGroups/@{resourceGroup().name}/providers/Microsoft.Insights/components/@{parameters('$connections')['azureblob']['connectionId']}/query?api-version=2018-04-20",
        "authentication": {
          "type": "ManagedServiceIdentity"
        }
      },
      "runAfter": {
        "Comment_Why_Parallel_Collection": ["Succeeded"]
      }
    },
    "Get_Secure_Score": {
      "type": "Http",
      "inputs": {
        "method": "GET",
        "uri": "https://management.azure.com/subscriptions/@{subscription().subscriptionId}/providers/Microsoft.Security/secureScores/ascScore?api-version=2020-01-01",
        "authentication": {
          "type": "ManagedServiceIdentity"
        }
      },
      "runAfter": {
        "Comment_Why_Parallel_Collection": ["Succeeded"]
      }
    },
    "Get_Policy_Compliance": {
      "type": "Http",
      "inputs": {
        "method": "POST",
        "uri": "https://management.azure.com/subscriptions/@{subscription().subscriptionId}/providers/Microsoft.PolicyInsights/policyStates/latest/summarize?api-version=2019-10-01",
        "authentication": {
          "type": "ManagedServiceIdentity"
        }
      },
      "runAfter": {
        "Comment_Why_Parallel_Collection": ["Succeeded"]
      }
    },
    "Get_Activity_Log": {
      "type": "Http",
      "inputs": {
        "method": "GET",
        "uri": "https://management.azure.com/subscriptions/@{subscription().subscriptionId}/providers/Microsoft.Insights/eventtypes/management/values?api-version=2015-04-01&$filter=eventTimestamp ge '@{addDays(utcNow(), -1)}' and eventTimestamp le '@{utcNow()}'&$select=eventTimestamp,operationName,resourceId,caller",
        "authentication": {
          "type": "ManagedServiceIdentity"
        }
      },
      "runAfter": {
        "Comment_Why_Parallel_Collection": ["Succeeded"]
      }
    },
    "Comment_Why_Historical_Storage": {
      "type": "Compose",
      "inputs": "Store metrics in Table Storage for trend analysis. Why: Auditors and compliance teams need to see improvement/degradation over time, not just current state. Historical data proves continuous compliance.",
      "runAfter": {
        "Get_Availability_Data": ["Succeeded"],
        "Get_Secure_Score": ["Succeeded"],
        "Get_Policy_Compliance": ["Succeeded"],
        "Get_Activity_Log": ["Succeeded"]
      }
    },
    "Parse_Secure_Score": {
      "type": "ParseJson",
      "inputs": {
        "content": "@body('Get_Secure_Score')",
        "schema": {
          "type": "object",
          "properties": {
            "properties": {
              "type": "object",
              "properties": {
                "score": {
                  "type": "object",
                  "properties": {
                    "current": {"type": "number"},
                    "max": {"type": "number"},
                    "percentage": {"type": "number"}
                  }
                }
              }
            }
          }
        }
      },
      "runAfter": {
        "Comment_Why_Historical_Storage": ["Succeeded"]
      }
    },
    "Parse_Policy_Compliance": {
      "type": "ParseJson",
      "inputs": {
        "content": "@body('Get_Policy_Compliance')",
        "schema": {
          "type": "object",
          "properties": {
            "value": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "policyAssignments": {"type": "integer"},
                  "results": {
                    "type": "object",
                    "properties": {
                      "nonCompliantResources": {"type": "integer"},
                      "nonCompliantPolicies": {"type": "integer"}
                    }
                  }
                }
              }
            }
          }
        }
      },
      "runAfter": {
        "Parse_Secure_Score": ["Succeeded"]
      }
    },
    "Compose_Current_Metrics": {
      "type": "Compose",
      "inputs": {
        "timestamp": "@variables('currentTimestamp')",
        "secureScore": "@body('Parse_Secure_Score')?['properties']?['score']?['percentage']",
        "policyCompliance": "@div(sub(body('Parse_Policy_Compliance')?['value']?[0]?['policyAssignments'], body('Parse_Policy_Compliance')?['value']?[0]?['results']?['nonCompliantPolicies']), body('Parse_Policy_Compliance')?['value']?[0]?['policyAssignments'])",
        "nonCompliantPolicies": "@body('Parse_Policy_Compliance')?['value']?[0]?['results']?['nonCompliantPolicies']"
      },
      "runAfter": {
        "Parse_Policy_Compliance": ["Succeeded"]
      }
    },
    "Comment_Why_Alert_Logic": {
      "type": "Compose",
      "inputs": "Check if metrics crossed alert thresholds. Why: Proactive alerting prevents compliance violations from going unnoticed. Teams get notified immediately when security posture degrades.",
      "runAfter": {
        "Compose_Current_Metrics": ["Succeeded"]
      }
    },
    "Check_Secure_Score_Threshold": {
      "type": "If",
      "expression": {
        "and": [
          {
            "less": [
              "@outputs('Compose_Current_Metrics')?['secureScore']",
              70
            ]
          }
        ]
      },
      "actions": {
        "Set_Alert_For_Low_Score": {
          "type": "SetVariable",
          "inputs": {
            "name": "alertNeeded",
            "value": true
          }
        },
        "Append_Score_Alert_Message": {
          "type": "AppendToStringVariable",
          "inputs": {
            "name": "alertMessage",
            "value": "‚ö†Ô∏è Secure Score dropped below 70% (currently @{outputs('Compose_Current_Metrics')?['secureScore']}%)\n"
          },
          "runAfter": {
            "Set_Alert_For_Low_Score": ["Succeeded"]
          }
        }
      },
      "runAfter": {
        "Comment_Why_Alert_Logic": ["Succeeded"]
      }
    },
    "Check_Policy_Compliance": {
      "type": "If",
      "expression": {
        "and": [
          {
            "greater": [
              "@outputs('Compose_Current_Metrics')?['nonCompliantPolicies']",
              5
            ]
          }
        ]
      },
      "actions": {
        "Set_Alert_For_Policy_Violations": {
          "type": "SetVariable",
          "inputs": {
            "name": "alertNeeded",
            "value": true
          }
        },
        "Append_Policy_Alert_Message": {
          "type": "AppendToStringVariable",
          "inputs": {
            "name": "alertMessage",
            "value": "‚ö†Ô∏è Policy compliance violations detected: @{outputs('Compose_Current_Metrics')?['nonCompliantPolicies']} non-compliant policies\n"
          },
          "runAfter": {
            "Set_Alert_For_Policy_Violations": ["Succeeded"]
          }
        }
      },
      "runAfter": {
        "Check_Secure_Score_Threshold": ["Succeeded"]
      }
    },
    "Comment_Why_Table_Storage": {
      "type": "Compose",
      "inputs": "Table Storage is cost-effective for time-series data. Why: Costs ~$1/month for 30 days of hourly metrics vs. $50+/month for Cosmos DB. Perfect for compliance dashboards that don't need millisecond queries.",
      "runAfter": {
        "Check_Policy_Compliance": ["Succeeded"]
      }
    },
    "Insert_Historical_Metric": {
      "type": "ApiConnection",
      "inputs": {
        "host": {
          "connection": {
            "name": "@parameters('$connections')['azuretables']['connectionId']"
          }
        },
        "method": "post",
        "path": "/Tables/@{encodeURIComponent('ComplianceHistory')}/entities",
        "body": {
          "PartitionKey": "@{formatDateTime(utcNow(), 'yyyy-MM')}",
          "RowKey": "@{formatDateTime(utcNow(), 'yyyy-MM-dd-HH-mm')}",
          "Timestamp": "@variables('currentTimestamp')",
          "SecureScore": "@outputs('Compose_Current_Metrics')?['secureScore']",
          "PolicyCompliancePercent": "@mul(outputs('Compose_Current_Metrics')?['policyCompliance'], 100)",
          "NonCompliantPolicies": "@outputs('Compose_Current_Metrics')?['nonCompliantPolicies']"
        }
      },
      "runAfter": {
        "Comment_Why_Table_Storage": ["Succeeded"]
      }
    },
    "Send_Alert_If_Needed": {
      "type": "If",
      "expression": {
        "and": [
          {
            "equals": [
              "@variables('alertNeeded')",
              true
            ]
          },
          {
            "not": {
              "equals": [
                "@parameters('alertEmailAddress')",
                ""
              ]
            }
          }
        ]
      },
      "actions": {
        "Comment_Why_Email_Alerts": {
          "type": "Compose",
          "inputs": "Email alerts ensure compliance team is notified. Why: Trust center dashboards are passive; alerts are proactive. Critical for SOC 2 and ISO 27001 incident response requirements."
        },
        "Send_Email_Alert": {
          "type": "ApiConnection",
          "inputs": {
            "host": {
              "connection": {
                "name": "@parameters('$connections')['office365']['connectionId']"
              }
            },
            "method": "post",
            "path": "/v2/Mail",
            "body": {
              "To": "@parameters('alertEmailAddress')",
              "Subject": "üö® Compliance Alert - Azure Trust Center",
              "Body": "<h2>Compliance Alert Detected</h2><p>The following issues were detected in your Azure environment:</p><pre>@{variables('alertMessage')}</pre><p>Please review the <a href='https://portal.azure.com'>Azure Portal</a> for details.</p><p><small>Automated alert from Azure Mini Trust Center</small></p>",
              "Importance": "High"
            }
          },
          "runAfter": {
            "Comment_Why_Email_Alerts": ["Succeeded"]
          }
        }
      },
      "runAfter": {
        "Insert_Historical_Metric": ["Succeeded"]
      }
    },
    "Update_Dashboard_Files": {
      "type": "Compose",
      "inputs": "Final step: Update JSON files for dashboard display",
      "runAfter": {
        "Send_Alert_If_Needed": ["Succeeded"]
      }
    }
  },
  "outputs": {}
}
