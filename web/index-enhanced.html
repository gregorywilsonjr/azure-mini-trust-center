<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aftershock | Transparency Trust Center (TTC) (Azure) - Enhanced</title>
  <!-- Why: Chart.js for trend visualization. Lightweight (60KB) and no dependencies. -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; padding: 2rem; background:#0b0f14; color:#e6eef8; }
    
    /* Why: Tabs allow switching between current metrics and compliance frameworks without cluttering the view */
    .tabs { display:flex; gap:1rem; margin-bottom:1.5rem; border-bottom:2px solid #1e293b; }
    .tab { padding:0.75rem 1.5rem; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-2px; transition:all 0.2s; }
    .tab:hover { background:#1e293b; }
    .tab.active { border-bottom-color:#8ab4ff; color:#8ab4ff; font-weight:600; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    
    .grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    
    /* Why: Wide cards for trend charts need more space than metric cards */
    .card { background:#121822; border:1px solid #1e293b; border-radius:16px; padding:1.25rem; box-shadow:0 6px 20px rgba(0,0,0,.25); min-height:120px; display:flex; flex-direction:column; }
    .card.wide { grid-column: span 2; min-height:300px; }
    .card.full { grid-column: 1 / -1; }
    
    .title { font-size:0.95rem; opacity:.8; margin-bottom:.5rem; word-wrap:break-word; }
    .value { font-size:1.75rem; font-weight:700; margin:.25rem 0 .75rem; word-wrap:break-word; overflow-wrap:break-word; line-height:1.2; }
    .meta { font-size:.8rem; opacity:.8; word-wrap:break-word; overflow-wrap:break-word; line-height:1.4; }
    .chip { display:inline-block; padding:.2rem .6rem; border-radius:999px; font-size:.75rem; margin-left:.5rem; white-space:nowrap; }
    .ok { background:#063; }
    .warn { background:#704; }
    .info { background:#036; }
    
    /* Why: Framework cards show compliance percentage with visual progress bar */
    .framework-card { margin-bottom:1rem; padding:1rem; background:#1a1f2e; border-radius:8px; border-left:4px solid #8ab4ff; }
    .framework-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; }
    .framework-name { font-weight:600; font-size:1.1rem; }
    .framework-percent { font-size:1.5rem; font-weight:700; color:#8ab4ff; }
    .progress-bar { height:8px; background:#1e293b; border-radius:4px; overflow:hidden; margin:0.5rem 0; }
    .progress-fill { height:100%; background:linear-gradient(90deg, #063, #0a6); transition:width 0.5s; }
    .controls-list { margin-top:0.75rem; font-size:0.85rem; opacity:0.9; }
    .control-item { padding:0.25rem 0; display:flex; align-items:center; gap:0.5rem; }
    .control-status { width:8px; height:8px; border-radius:50%; }
    .control-status.compliant { background:#0a6; }
    .control-status.partial { background:#fa0; }
    .control-status.non-compliant { background:#c33; }
    
    /* Why: Trend period selector lets users switch between 7-day and 30-day views */
    .period-selector { display:flex; gap:0.5rem; margin-bottom:1rem; }
    .period-btn { padding:0.5rem 1rem; background:#1e293b; border:1px solid #334155; border-radius:6px; cursor:pointer; font-size:0.85rem; transition:all 0.2s; }
    .period-btn:hover { background:#334155; }
    .period-btn.active { background:#8ab4ff; color:#0b0f14; border-color:#8ab4ff; font-weight:600; }
    
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.25rem; flex-wrap:wrap; gap:0.5rem; }
    h1 { font-size:1.4rem; margin:0; }
    h2 { font-size:1.2rem; margin:1.5rem 0 1rem; opacity:0.9; }
    a { color:#8ab4ff; text-decoration:none; }
    a:hover { text-decoration:underline; }
    footer { margin-top:2rem; opacity:.7; font-size:.85rem; padding-top:1rem; border-top:1px solid #1e293b; }
    
    @media (max-width: 768px) {
      body { padding: 1rem; }
      .grid { grid-template-columns: 1fr; }
      .card.wide, .card.full { grid-column: 1; }
      .value { font-size:1.5rem; }
      .tabs { overflow-x:auto; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Aftershock Cyber Solutions â€” Transparency Trust Center (TTC)</h1>
    <div>Auditâ€‘Ready, Every Day</div>
  </header>

  <!-- Why: Tabs organize information - current metrics vs. compliance frameworks vs. trends -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('current')">Current Metrics</div>
    <div class="tab" onclick="switchTab('frameworks')">Compliance Frameworks</div>
    <div class="tab" onclick="switchTab('trends')">Historical Trends</div>
  </div>

  <!-- Tab 1: Current Metrics (original dashboard) -->
  <div id="tab-current" class="tab-content active">
    <div class="grid" id="cards-current"></div>
  </div>

  <!-- Tab 2: Compliance Frameworks -->
  <div id="tab-frameworks" class="tab-content">
    <div class="grid">
      <div class="card full">
        <div class="title">Compliance Framework Overview</div>
        <div class="meta">Why: Maps Azure policies to industry frameworks. Auditors need to see which SOC 2, ISO 27001, PCI DSS, NIST, and GDPR controls are covered.</div>
      </div>
    </div>
    <div id="frameworks-container"></div>
  </div>

  <!-- Tab 3: Historical Trends -->
  <div id="tab-trends" class="tab-content">
    <div class="period-selector">
      <div class="period-btn active" onclick="switchPeriod(7)">7 Days</div>
      <div class="period-btn" onclick="switchPeriod(30)">30 Days</div>
    </div>
    <div class="grid">
      <!-- Why: Trend charts show compliance improvement/degradation over time -->
      <div class="card wide">
        <div class="title">Secure Score Trend</div>
        <canvas id="chart-secure-score"></canvas>
      </div>
      <div class="card wide">
        <div class="title">Policy Compliance Trend</div>
        <canvas id="chart-policy-compliance"></canvas>
      </div>
    </div>
    <div class="grid" style="margin-top:1rem;">
      <div class="card">
        <div class="title">Trend Analysis</div>
        <div class="value" id="trend-summary">Loading...</div>
        <div class="meta" id="trend-details">Analyzing historical data...</div>
      </div>
    </div>
  </div>

  <footer>
    Evidence: <a href="evidence/Pentest_Summary_Redacted.pdf">Pen Test (Redacted)</a> Â· 
    <a href="evidence/Policy_Snapshot_Redacted.pdf">Policy Snapshot</a> Â· 
    <span style="opacity:0.5;">Enhanced with historical trends, multi-subscription support, and compliance framework mapping</span>
  </footer>

<script>
// Why: Utility functions for data fetching and UI components
async function fetchJSON(path){ const r = await fetch(path); return r.ok ? r.json() : null; }

function chip(value, ok=true){ 
  const span=document.createElement('span'); 
  span.className='chip '+(ok?'ok':'warn'); 
  span.textContent=value.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' '); 
  return span; 
}

function card(title, value, meta, ok=true){
  const c = document.createElement('div'); c.className='card';
  const t = document.createElement('div'); t.className='title'; t.textContent=title;
  const v = document.createElement('div'); v.className='value'; v.textContent=value;
  const m = document.createElement('div'); m.className='meta'; m.textContent=meta;
  c.append(t, v, m);
  t.appendChild(chip(ok?'OK':'Attention', ok));
  return c;
}

// Why: Tab switching for organized information display
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-' + tabName).classList.add('active');
  
  // Why: Load trend charts only when trends tab is opened (performance optimization)
  if(tabName === 'trends' && !window.trendsLoaded) {
    loadTrendCharts(7);
    window.trendsLoaded = true;
  }
}

// Why: Switch between 7-day and 30-day trend views
let currentPeriod = 7;
function switchPeriod(days) {
  currentPeriod = days;
  document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  loadTrendCharts(days);
}

// Why: Generate mock historical data (replace with real Table Storage data in production)
function generateMockHistoricalData(days) {
  const data = [];
  const now = new Date();
  for(let i = days; i >= 0; i--) {
    const date = new Date(now);
    date.setDate(date.getDate() - i);
    data.push({
      date: date.toISOString().split('T')[0],
      secureScore: 75 + Math.random() * 10 + (i < days/2 ? 5 : 0), // Trend upward
      policyCompliance: 80 + Math.random() * 8 + (i < days/2 ? 3 : 0)
    });
  }
  return data;
}

// Why: Chart.js configuration for trend visualization
let secureScoreChart, policyComplianceChart;
function loadTrendCharts(days) {
  const historicalData = generateMockHistoricalData(days);
  const labels = historicalData.map(d => d.date);
  const secureScores = historicalData.map(d => d.secureScore);
  const policyCompliance = historicalData.map(d => d.policyCompliance);
  
  const chartConfig = {
    type: 'line',
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: { 
          beginAtZero: false, 
          min: 60, 
          max: 100,
          ticks: { color: '#94a3b8' },
          grid: { color: '#1e293b' }
        },
        x: { 
          ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 },
          grid: { color: '#1e293b' }
        }
      }
    }
  };
  
  // Secure Score Chart
  if(secureScoreChart) secureScoreChart.destroy();
  const ctx1 = document.getElementById('chart-secure-score').getContext('2d');
  secureScoreChart = new Chart(ctx1, {
    ...chartConfig,
    data: {
      labels: labels,
      datasets: [{
        label: 'Secure Score %',
        data: secureScores,
        borderColor: '#8ab4ff',
        backgroundColor: 'rgba(138, 180, 255, 0.1)',
        fill: true,
        tension: 0.3
      }]
    }
  });
  
  // Policy Compliance Chart
  if(policyComplianceChart) policyComplianceChart.destroy();
  const ctx2 = document.getElementById('chart-policy-compliance').getContext('2d');
  policyComplianceChart = new Chart(ctx2, {
    ...chartConfig,
    data: {
      labels: labels,
      datasets: [{
        label: 'Policy Compliance %',
        data: policyCompliance,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        fill: true,
        tension: 0.3
      }]
    }
  });
  
  // Why: Trend analysis summary helps users quickly understand if compliance is improving
  const avgSecure = secureScores.reduce((a,b)=>a+b,0) / secureScores.length;
  const avgPolicy = policyCompliance.reduce((a,b)=>a+b,0) / policyCompliance.length;
  const secureChange = secureScores[secureScores.length-1] - secureScores[0];
  const policyChange = policyCompliance[policyCompliance.length-1] - policyCompliance[0];
  
  document.getElementById('trend-summary').textContent = 
    secureChange > 0 && policyChange > 0 ? 'ðŸ“ˆ Improving' : 
    secureChange < 0 || policyChange < 0 ? 'ðŸ“‰ Declining' : 'âž¡ï¸ Stable';
  
  document.getElementById('trend-details').textContent = 
    `Secure Score: ${secureChange > 0 ? '+' : ''}${secureChange.toFixed(1)}% Â· ` +
    `Policy Compliance: ${policyChange > 0 ? '+' : ''}${policyChange.toFixed(1)}% Â· ` +
    `Period: ${days} days`;
}

// Why: Render compliance framework cards with progress bars
function renderFrameworks(frameworks) {
  const container = document.getElementById('frameworks-container');
  container.innerHTML = '';
  
  Object.entries(frameworks.frameworks).forEach(([key, framework]) => {
    const card = document.createElement('div');
    card.className = 'framework-card';
    
    const header = document.createElement('div');
    header.className = 'framework-header';
    header.innerHTML = `
      <div>
        <div class="framework-name">${framework.name}</div>
        <div style="font-size:0.85rem;opacity:0.7;margin-top:0.25rem;">${framework.description}</div>
      </div>
      <div class="framework-percent">${framework.overallCompliance}%</div>
    `;
    
    const progress = document.createElement('div');
    progress.className = 'progress-bar';
    progress.innerHTML = `<div class="progress-fill" style="width:${framework.overallCompliance}%"></div>`;
    
    const controls = document.createElement('div');
    controls.className = 'controls-list';
    controls.innerHTML = `
      <div style="margin-bottom:0.5rem;font-weight:600;">
        ${framework.compliantControls}/${framework.totalControls} controls compliant
      </div>
    `;
    
    // Why: Show top 3 controls to give auditors quick insight into coverage
    framework.controls.slice(0, 3).forEach(control => {
      const item = document.createElement('div');
      item.className = 'control-item';
      item.innerHTML = `
        <div class="control-status ${control.status}"></div>
        <div><strong>${control.id}</strong>: ${control.name}</div>
      `;
      controls.appendChild(item);
    });
    
    if(framework.controls.length > 3) {
      controls.innerHTML += `<div style="margin-top:0.5rem;opacity:0.6;">+ ${framework.controls.length - 3} more controls</div>`;
    }
    
    card.appendChild(header);
    card.appendChild(progress);
    card.appendChild(controls);
    container.appendChild(card);
  });
  
  // Why: Summary card shows aggregate compliance across all frameworks
  const summary = document.createElement('div');
  summary.className = 'card full';
  summary.style.marginTop = '1rem';
  summary.innerHTML = `
    <div class="title">Overall Compliance Summary</div>
    <div class="value">${frameworks.summary.averageCompliance}% Average</div>
    <div class="meta">
      ${frameworks.summary.totalFrameworks} frameworks Â· 
      ${frameworks.summary.totalControlsMapped} controls mapped Â· 
      ${frameworks.summary.compliantControls} compliant Â· 
      ${frameworks.summary.partialControls} partial Â· 
      ${frameworks.summary.nonCompliantControls} non-compliant
    </div>
  `;
  container.appendChild(summary);
}

// Why: Load all data on page load
(async ()=>{
  const grid = document.getElementById('cards-current');

  const [uptime, security, policy, changes, tenable, frameworks] = await Promise.all([
    fetchJSON('data/uptime.json'),
    fetchJSON('data/security.json'),
    fetchJSON('data/policy.json'),
    fetchJSON('data/changes.json'),
    fetchJSON('data/tenable.json'),
    fetchJSON('data/compliance-frameworks.json')
  ]);

  // Render current metrics (original dashboard)
  if(uptime){
    const availability = parseFloat(uptime.availability ?? 0);
    grid.append(card('Uptime (24h)',
      availability.toFixed(2) + '%',
      `Checks: ${uptime.tests} Â· Failures: ${uptime.failures} Â· As of: ${uptime.lastCheck}`,
      availability >= 99.9));
  }

  if(security){
    const highRecs = parseInt(security.highRecs ?? 0);
    const ok = highRecs === 0;
    grid.append(card('Security Posture',
      `Score: ${security.secureScore ?? 0}`,
      `High Recs: ${security.highRecs ?? 0} Â· Medium Recs: ${security.mediumRecs ?? 0} Â· Updated: ${security.lastUpdated}`,
      ok));
  }

  if(policy){
    const assignmentsEvaluated = parseInt(policy.assignmentsEvaluated ?? 0);
    const nonCompliant = parseInt(policy.nonCompliant ?? 0);
    const ok = nonCompliant === 0;
    grid.append(card('Policy Compliance',
      `${assignmentsEvaluated - nonCompliant}/${assignmentsEvaluated} compliant`,
      `Nonâ€‘compliant: ${policy.nonCompliant ?? 0} Â· Updated: ${policy.lastUpdated}`,
      ok));
  }

  if(changes){
    const c = changes.mostRecentChange || {};
    const ok = true;
    const action = (c.action || '').toLowerCase();
    const resourceType = (c.resource || '').toLowerCase();
    let description = 'Configuration change';
    
    if(action.includes('write')) {
      if(resourceType.includes('nsg') || resourceType.includes('security')) description = 'Security rule updated';
      else if(resourceType.includes('vm') || resourceType.includes('compute')) description = 'VM configuration changed';
      else if(resourceType.includes('storage')) description = 'Storage settings modified';
      else if(resourceType.includes('network')) description = 'Network configuration updated';
      else description = 'Resource updated';
    } else if(action.includes('delete')) {
      description = 'Resource deleted';
    } else if(action.includes('action')) {
      description = 'Action performed';
    }
    
    const shortActor = (c.actor || '').replace('user:', '').replace('servicePrincipal:', 'SP: ');
    const shortTime = (c.time || '').split('T')[0] || c.time;
    grid.append(card('Recent Change',
      description,
      `Resource: ${c.resource || 'â€”'} Â· By: ${shortActor || 'â€”'} Â· When: ${shortTime || 'â€”'}`,
      ok));
  }

  if(tenable){
    const critical = parseInt(tenable.vulnerabilitySummary?.critical ?? 0);
    const high = parseInt(tenable.vulnerabilitySummary?.high ?? 0);
    const ok = critical === 0 && high <= 1;
    grid.append(card('Vulnerability Summary (Tenable)',
      `Critical: ${tenable.vulnerabilitySummary?.critical ?? 0} Â· High: ${tenable.vulnerabilitySummary?.high ?? 0}`,
      `Medium: ${tenable.vulnerabilitySummary?.medium ?? 0} Â· Last Scan: ${tenable.vulnerabilitySummary?.lastScan || 'â€”'}`,
      ok));
  }
  
  // Why: Render compliance frameworks if data available
  if(frameworks) {
    renderFrameworks(frameworks);
  }
})();
</script>
</body>
</html>
